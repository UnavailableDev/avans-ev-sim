@startuml Thread Activity Diagram

!define THREAD_COLOR #CCFFCC
!define SYNC_COLOR #FFCCCC

title Thread Activity Flow: SimulationManager to EV Charging

participant "Main Thread" as Main
participant "TrafficFlow Threads\n(Array of threads)" as TFThreads
participant "Vehicle Threads\n(Array of threads)" as VThreads
participant "Station Threads\n(Array of threads)" as SThreads

== Simulation Step ==
Main -> Main: StepSimulation(steps)
Main -> Main: Create TrafficFlow threads\n(one per traffic flow)

== TrafficFlow Update Phase ==
loop each traffic flow
    Main ->> TFThreads: Launch thread for\nTrafficFlow::StepSimulation()
end

par TrafficFlow Threads Execute (parallel)
    TFThreads -> TFThreads: StepSimulation(minutes, speed_limit)
    TFThreads -> TFThreads: Calculate distance_km\nfor this time step
    
    par Vehicle Simulation (parallel within each flow)
        TFThreads ->> VThreads: Create Vehicle threads\n(one per vehicle in flow)
        
        loop each vehicle
            VThreads -> VThreads: Vehicle::Move(distance_km)
            
            alt EV::Action() checks
                opt if SOC < 20%, find charging station
                    VThreads ->> SThreads: station->HandleArrival()
                    Note over SThreads: Mutex locks queue
                    SThreads -> SThreads: Add EV to queue
                    VThreads -> VThreads: Return false (stop movement)
                else if atStation & SOC < 90%
                    VThreads -> VThreads: Return false (wait for charge)
                else if atStation & SOC >= 90%
                    VThreads -> VThreads: Return true (leave station)
                else
                    VThreads -> VThreads: Return true (continue)
                end
            end
            
            alt If allowed to move
                VThreads -> VThreads: Update position & SOC
            end
        end
        
        par Wait for all vehicle threads to complete
            VThreads -> VThreads: Join all vehicle threads
        end
    end
    
    par Station Update (parallel within each flow)
        TFThreads ->> SThreads: Create Station threads\n(one per station in flow)
        
        loop each station
            SThreads -> SThreads: Station::Update()
            Note over SThreads: Mutex locks queue
            
            opt if EV in queue
                SThreads -> SThreads: Charge EV to 100%
                SThreads -> SThreads: Update statistics
            end
        end
        
        par Wait for all station threads to complete
            SThreads -> SThreads: Join all station threads
        end
    end
end

== Back to Main Thread ==
Main <- TFThreads: All TrafficFlow threads complete
Main -> Main: PrintStatus()
Main -> Main: Report queue lengths &\ncharging statistics

@enduml
